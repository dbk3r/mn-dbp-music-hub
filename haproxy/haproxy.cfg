global
  log stdout format raw local0

defaults
  log global
  mode http
  option httplog
  option forwardfor
  timeout connect 5s
  timeout client  60s
  timeout server  60s

frontend fe_http
  bind *:80

  acl is_custom path_beg /custom
  acl is_admin path_beg /dbp-admin
  acl is_admin_login path -i /admin/auth/login

  # Normalize basePath entrypoint (avoid redirect loops with Next.js)
  http-request redirect location /dbp-admin code 301 if { path -i /dbp-admin/ }

  # Rewrite admin login path to use the custom admin login handler
  http-request set-path /custom/admin/auth/login if is_admin_login

  use_backend be_backend if is_custom
  use_backend be_admin if is_admin
  default_backend be_frontend

backend be_frontend
  http-request set-header X-Forwarded-Proto http
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
  server frontend frontend:3000 check

backend be_admin
  http-request set-header X-Forwarded-Proto http
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
  server admin admin:7000 check

backend be_backend
  http-request set-header X-Forwarded-Proto http
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
  server backend backend:9000 check
