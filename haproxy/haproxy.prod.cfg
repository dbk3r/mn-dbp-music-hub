global
  log stdout format raw local0
  # SSL/TLS Settings
  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
  log global
  mode http
  option httplog
  option forwardfor
  timeout connect 5s
  timeout client  60s
  timeout server  60s

frontend fe_http
  bind *:80
  bind *:443 ssl crt /etc/haproxy/certs/live/dbp-music-hub.de/combined.pem

  # Rewrite admin static asset requests from /dbp-admin/_next/... to /_next/...
  acl is_admin_next path_beg /dbp-admin/_next
  http-request replace-path ^/dbp-admin/_next(/.*)$ /_next\1 if is_admin_next

  # Force HTTPS Redirect
  redirect scheme https code 301 if !{ ssl_fc }

  acl is_custom path_beg /custom
  acl is_backend path_beg /dbp-backend
  acl is_admin path_beg /dbp-admin
  acl is_admin_login path -i /admin/auth/login

  # Normalize basePath entrypoint (avoid redirect loops with Next.js)
  http-request redirect location /dbp-admin code 301 if { path -i /dbp-admin/ }

  # Rewrite admin login path to use the custom admin login handler
  http-request set-path /custom/admin/auth/login if is_admin_login

  # Rewrite /dbp-backend/custom/... to /custom/... for backend routes
  http-request replace-path ^/dbp-backend(/custom/.*)$ \1 if is_backend

  # Rewrite admin static asset requests from /dbp-admin/_next/... to /_next/...
  acl is_admin_next path_beg /dbp-admin/_next
  http-request replace-path ^/dbp-admin/_next(/.*)$ /_next\1 if is_admin_next

  # Set security headers
  http-response set-header X-Frame-Options SAMEORIGIN
  http-response set-header X-Content-Type-Options nosniff
  http-response set-header X-XSS-Protection "1; mode=block"
  http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"

  use_backend be_backend if is_custom
  use_backend be_backend if is_backend
  use_backend be_admin if is_admin
  default_backend be_frontend

backend be_frontend
  http-request set-header X-Forwarded-Proto https
  http-request set-header X-Forwarded-Host dbp-music-hub.de
  server frontend frontend:3000 check

backend be_admin
  http-request set-header X-Forwarded-Proto https
  http-request set-header X-Forwarded-Host dbp-music-hub.de
  server admin admin:7000 check

backend be_backend
  http-request set-header X-Forwarded-Proto https
  http-request set-header X-Forwarded-Host dbp-music-hub.de
  server backend backend:9000 check
